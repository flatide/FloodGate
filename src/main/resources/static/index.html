<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FloodGate 2</title>
<style>
:root {
  --bg: #f4f5f7;
  --header-bg: #1a1a2e;
  --header-text: #e0e0e0;
  --card-bg: #ffffff;
  --accent: #2563eb;
  --accent-hover: #1d4ed8;
  --danger: #dc2626;
  --danger-hover: #b91c1c;
  --success: #16a34a;
  --text: #1e293b;
  --text-secondary: #64748b;
  --border: #e2e8f0;
  --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.07), 0 2px 4px rgba(0,0,0,0.06);
  --radius: 8px;
  --mono: 'SF Mono', 'Fira Code', 'Cascadia Code', 'Consolas', monospace;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
}

/* Header */
header {
  background: var(--header-bg);
  color: var(--header-text);
  padding: 0 24px;
  height: 56px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

header h1 {
  font-size: 20px;
  font-weight: 600;
  letter-spacing: -0.3px;
}

#health-btn {
  background: none;
  border: 1px solid rgba(255,255,255,0.15);
  color: var(--header-text);
  padding: 6px 14px;
  border-radius: 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  transition: background 0.2s;
}

#health-btn:hover { background: rgba(255,255,255,0.08); }

#health-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: #666;
  transition: background 0.3s;
}

#health-dot.up { background: #22c55e; box-shadow: 0 0 6px #22c55e80; }
#health-dot.down { background: #ef4444; box-shadow: 0 0 6px #ef444480; }

/* Tabs */
.tab-bar {
  display: flex;
  background: var(--card-bg);
  border-bottom: 1px solid var(--border);
  padding: 0 24px;
  box-shadow: var(--shadow);
  overflow-x: auto;
}

.tab-bar button {
  background: none;
  border: none;
  padding: 14px 20px;
  font-size: 14px;
  font-weight: 500;
  color: var(--text-secondary);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  white-space: nowrap;
  transition: color 0.2s, border-color 0.2s;
}

.tab-bar button:hover { color: var(--text); }
.tab-bar button.active { color: var(--accent); border-bottom-color: var(--accent); }

/* Main content */
main {
  max-width: 1200px;
  margin: 24px auto;
  padding: 0 24px;
}

.tab-content { display: none; }
.tab-content.active { display: block; }

/* Cards */
.card {
  background: var(--card-bg);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 20px;
  margin-bottom: 16px;
}

.card h3 {
  font-size: 15px;
  font-weight: 600;
  margin-bottom: 12px;
  color: var(--text);
}

/* Forms */
label {
  display: block;
  font-size: 13px;
  font-weight: 500;
  color: var(--text-secondary);
  margin-bottom: 4px;
}

select, input[type="text"], textarea {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 14px;
  font-family: inherit;
  outline: none;
  transition: border-color 0.2s;
}

select:focus, input[type="text"]:focus, textarea:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

textarea.json-editor {
  font-family: var(--mono);
  font-size: 13px;
  line-height: 1.5;
  resize: vertical;
  min-height: 120px;
  tab-size: 2;
}

/* Buttons */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.2s;
}

.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: var(--accent-hover); }
.btn-danger { background: var(--danger); color: #fff; }
.btn-danger:hover { background: var(--danger-hover); }
.btn-outline {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text);
}
.btn-outline:hover { background: var(--bg); }
.btn-sm { padding: 5px 10px; font-size: 12px; }

.btn-group { display: flex; gap: 8px; flex-wrap: wrap; }

/* Table */
.data-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

.data-table th {
  text-align: left;
  padding: 10px 12px;
  font-weight: 600;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-secondary);
  border-bottom: 2px solid var(--border);
}

.data-table td {
  padding: 10px 12px;
  border-bottom: 1px solid var(--border);
  max-width: 400px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.data-table tr:hover td { background: #f8fafc; }
.data-table tr { cursor: pointer; }

/* JSON display */
.json-display {
  background: #f8fafc;
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 16px;
  font-family: var(--mono);
  font-size: 13px;
  line-height: 1.6;
  white-space: pre-wrap;
  word-break: break-word;
  max-height: 400px;
  overflow-y: auto;
}

/* Status badge */
.status {
  display: inline-block;
  padding: 3px 10px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
}

.status-ok { background: #dcfce7; color: #166534; }
.status-err { background: #fee2e2; color: #991b1b; }

/* Modal */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  z-index: 1000;
  justify-content: center;
  align-items: flex-start;
  padding-top: 80px;
}

.modal-overlay.open { display: flex; }

.modal {
  background: var(--card-bg);
  border-radius: var(--radius);
  box-shadow: var(--shadow-md);
  width: 100%;
  max-width: 600px;
  max-height: calc(100vh - 120px);
  overflow-y: auto;
  padding: 24px;
}

.modal h3 { margin-bottom: 16px; font-size: 17px; }

.form-group { margin-bottom: 14px; }

/* Log sub-tabs */
.sub-tabs {
  display: flex;
  gap: 4px;
  margin-bottom: 16px;
}

.sub-tabs button {
  padding: 6px 14px;
  border: 1px solid var(--border);
  background: var(--card-bg);
  border-radius: 6px;
  font-size: 13px;
  cursor: pointer;
  color: var(--text-secondary);
  transition: all 0.2s;
}

.sub-tabs button.active {
  background: var(--accent);
  color: #fff;
  border-color: var(--accent);
}

/* Responsive */
@media (max-width: 640px) {
  main { padding: 0 12px; margin: 12px auto; }
  .card { padding: 14px; }
  .tab-bar button { padding: 12px 14px; font-size: 13px; }
  header { padding: 0 12px; }
}

/* Loading spinner */
.spinner {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 2px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: var(--text-secondary);
  font-size: 14px;
}
</style>
</head>
<body>

<header>
  <h1>FloodGate 2</h1>
  <button id="health-btn" onclick="showHealth()">
    <span>Health</span>
    <span id="health-dot"></span>
  </button>
</header>

<nav class="tab-bar">
  <button class="active" onclick="switchTab('pipeline')">Pipeline</button>
  <button onclick="switchTab('api')">API</button>
  <button onclick="switchTab('flow')">Flow</button>
  <button onclick="switchTab('datasource')">Datasource</button>
  <button onclick="switchTab('transfer')">Transfer</button>
  <button onclick="switchTab('logs')">Logs</button>
</nav>

<main>
  <!-- Pipeline Runner -->
  <div id="tab-pipeline" class="tab-content active">
    <div class="card">
      <h3>Pipeline Runner</h3>
      <div class="form-group">
        <label for="api-select">API Name</label>
        <select id="api-select"><option value="">Loading...</option></select>
      </div>
      <div class="form-group">
        <label for="pipeline-body">Request Body (JSON)</label>
        <textarea id="pipeline-body" class="json-editor" rows="10">{
  "HEADER": {},
  "ITEMS": [
    {"name": "sample", "value": "hello"}
  ]
}</textarea>
      </div>
      <div class="btn-group">
        <button class="btn btn-primary" onclick="executePipeline()">Execute</button>
      </div>
    </div>
    <div id="pipeline-result" class="card" style="display:none">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
        <h3>Result</h3>
        <span id="pipeline-status" class="status"></span>
      </div>
      <div id="pipeline-output" class="json-display"></div>
    </div>
  </div>

  <!-- API Metadata -->
  <div id="tab-api" class="tab-content">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
        <h3>FG_API</h3>
        <div class="btn-group">
          <button class="btn btn-outline btn-sm" onclick="loadMeta('FG_API')">Refresh</button>
          <button class="btn btn-primary btn-sm" onclick="openMetaModal('FG_API')">New</button>
        </div>
      </div>
      <div id="meta-list-FG_API"></div>
    </div>
    <div id="meta-detail-FG_API" class="card" style="display:none">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
        <h3>Detail</h3>
        <div class="btn-group">
          <button class="btn btn-outline btn-sm" onclick="editMetaEntry('FG_API')">Edit</button>
          <button class="btn btn-danger btn-sm" onclick="deleteMetaEntry('FG_API')">Delete</button>
        </div>
      </div>
      <div id="meta-detail-content-FG_API" class="json-display"></div>
    </div>
  </div>

  <!-- Flow Metadata -->
  <div id="tab-flow" class="tab-content">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
        <h3>FG_FLOW</h3>
        <div class="btn-group">
          <button class="btn btn-outline btn-sm" onclick="loadMeta('FG_FLOW')">Refresh</button>
          <button class="btn btn-primary btn-sm" onclick="openMetaModal('FG_FLOW')">New</button>
        </div>
      </div>
      <div id="meta-list-FG_FLOW"></div>
    </div>
    <div id="meta-detail-FG_FLOW" class="card" style="display:none">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
        <h3>Detail</h3>
        <div class="btn-group">
          <button class="btn btn-outline btn-sm" onclick="editMetaEntry('FG_FLOW')">Edit</button>
          <button class="btn btn-danger btn-sm" onclick="deleteMetaEntry('FG_FLOW')">Delete</button>
        </div>
      </div>
      <div id="meta-detail-content-FG_FLOW" class="json-display"></div>
    </div>
  </div>

  <!-- Datasource Metadata -->
  <div id="tab-datasource" class="tab-content">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
        <h3>FG_DATASOURCE</h3>
        <div class="btn-group">
          <button class="btn btn-outline btn-sm" onclick="loadMeta('FG_DATASOURCE')">Refresh</button>
          <button class="btn btn-primary btn-sm" onclick="openMetaModal('FG_DATASOURCE')">New</button>
        </div>
      </div>
      <div id="meta-list-FG_DATASOURCE"></div>
    </div>
    <div id="meta-detail-FG_DATASOURCE" class="card" style="display:none">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
        <h3>Detail</h3>
        <div class="btn-group">
          <button class="btn btn-outline btn-sm" onclick="editMetaEntry('FG_DATASOURCE')">Edit</button>
          <button class="btn btn-danger btn-sm" onclick="deleteMetaEntry('FG_DATASOURCE')">Delete</button>
        </div>
      </div>
      <div id="meta-detail-content-FG_DATASOURCE" class="json-display"></div>
    </div>
  </div>

  <!-- Transfer -->
  <div id="tab-transfer" class="tab-content">
    <div class="card">
      <h3>File Transfer</h3>
      <div class="form-group">
        <label for="transfer-datasource">Datasource</label>
        <select id="transfer-datasource"><option value="">Loading...</option></select>
      </div>
      <div class="form-group">
        <label for="transfer-file">File</label>
        <input type="file" id="transfer-file" style="padding:6px 0;">
      </div>
      <div class="form-group">
        <label for="transfer-filename">Remote Filename (optional, defaults to selected file name)</label>
        <input type="text" id="transfer-filename" placeholder="e.g. data.csv">
      </div>
      <div class="btn-group">
        <button class="btn btn-primary" id="transfer-start-btn" onclick="startTransfer()">Start Transfer</button>
        <button class="btn btn-danger" id="transfer-cancel-btn" onclick="cancelTransfer()" style="display:none">Cancel</button>
      </div>
    </div>
    <div id="transfer-progress-card" class="card" style="display:none">
      <h3>Progress</h3>
      <div style="margin-bottom:8px;">
        <div style="display:flex;justify-content:space-between;font-size:13px;color:var(--text-secondary);margin-bottom:4px;">
          <span id="transfer-info">0 MB / 0 MB</span>
          <span id="transfer-rate">0 MB/s</span>
        </div>
        <div style="background:var(--border);border-radius:4px;height:20px;overflow:hidden;">
          <div id="transfer-bar" style="background:var(--accent);height:100%;width:0%;transition:width 0.3s;border-radius:4px;"></div>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text-secondary);margin-top:4px;">
          <span id="transfer-percent">0%</span>
          <span id="transfer-status-text">Ready</span>
        </div>
      </div>
    </div>
    <div id="transfer-active-card" class="card" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <h3>Active Transfers</h3>
        <button class="btn btn-outline btn-sm" onclick="loadActiveTransfers()">Refresh</button>
      </div>
      <div id="transfer-active-list"></div>
    </div>
  </div>

  <!-- Logs -->
  <div id="tab-logs" class="tab-content">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
        <h3>Logs</h3>
        <button class="btn btn-outline btn-sm" onclick="loadLogs()">Refresh</button>
      </div>
      <div class="sub-tabs">
        <button class="active" onclick="switchLogTab('api-logs', this)">API Logs</button>
        <button onclick="switchLogTab('flow-logs', this)">Flow Logs</button>
      </div>
      <div id="api-logs"></div>
      <div id="flow-logs" style="display:none"></div>
    </div>
    <div id="log-detail" class="card" style="display:none">
      <h3>Log Detail</h3>
      <div id="log-detail-content" class="json-display"></div>
    </div>
  </div>
</main>

<!-- Modal -->
<div id="meta-modal" class="modal-overlay" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <h3 id="modal-title">New Entry</h3>
    <div class="form-group">
      <label for="modal-id">ID</label>
      <input type="text" id="modal-id" placeholder="Enter ID">
    </div>
    <div class="form-group">
      <label for="modal-data">DATA (JSON)</label>
      <textarea id="modal-data" class="json-editor" rows="12">{}</textarea>
    </div>
    <div class="btn-group" style="justify-content:flex-end; margin-top:16px;">
      <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" id="modal-save-btn" onclick="saveMetaEntry()">Save</button>
    </div>
  </div>
</div>

<!-- Health Modal -->
<div id="health-modal" class="modal-overlay" onclick="if(event.target===this)this.classList.remove('open')">
  <div class="modal">
    <h3>Health Status</h3>
    <div id="health-detail" class="json-display"></div>
    <div style="margin-top:16px; text-align:right;">
      <button class="btn btn-outline" onclick="document.getElementById('health-modal').classList.remove('open')">Close</button>
    </div>
  </div>
</div>

<script>
// --- State ---
const state = {
  selectedMeta: {},  // { table: { id, data } }
  modalMode: null,   // 'create' or 'edit'
  modalTable: null,
  healthData: null
};

// --- Tabs ---
function switchTab(name) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab-bar button').forEach(el => el.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  // Find the tab button by matching text
  const tabs = document.querySelectorAll('.tab-bar button');
  const labels = { pipeline: 'Pipeline', api: 'API', flow: 'Flow', datasource: 'Datasource', transfer: 'Transfer', logs: 'Logs' };
  tabs.forEach(btn => { if (btn.textContent === labels[name]) btn.classList.add('active'); });
  // Load data on tab switch
  const tableMap = { api: 'FG_API', flow: 'FG_FLOW', datasource: 'FG_DATASOURCE' };
  if (tableMap[name]) loadMeta(tableMap[name]);
  if (name === 'logs') loadLogs();
  if (name === 'pipeline') loadApiList();
  if (name === 'transfer') { loadTransferDatasources(); loadActiveTransfers(); }
}

function switchLogTab(id, btn) {
  document.getElementById('api-logs').style.display = 'none';
  document.getElementById('flow-logs').style.display = 'none';
  document.getElementById(id).style.display = 'block';
  btn.parentElement.querySelectorAll('button').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

// --- API helpers ---
async function apiFetch(url, options = {}) {
  try {
    const res = await fetch(url, {
      headers: { 'Content-Type': 'application/json' },
      ...options
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    return await res.json();
  } catch (e) {
    console.error('API error:', e);
    throw e;
  }
}

function escapeHtml(s) {
  const div = document.createElement('div');
  div.textContent = s;
  return div.innerHTML;
}

function formatJson(obj) {
  try {
    return escapeHtml(JSON.stringify(obj, null, 2));
  } catch { return escapeHtml(String(obj)); }
}

// --- Health ---
async function checkHealth() {
  const dot = document.getElementById('health-dot');
  try {
    const data = await apiFetch('/health');
    state.healthData = data;
    dot.className = data.status === 'UP' ? 'up' : 'down';
  } catch {
    state.healthData = { status: 'DOWN', error: 'Connection failed' };
    dot.className = 'down';
  }
}

function showHealth() {
  const modal = document.getElementById('health-modal');
  document.getElementById('health-detail').innerHTML = formatJson(state.healthData || { status: 'unknown' });
  modal.classList.add('open');
}

// --- Pipeline ---
async function loadApiList() {
  const sel = document.getElementById('api-select');
  try {
    const list = await apiFetch('/meta/FG_API');
    sel.innerHTML = '<option value="">-- Select API --</option>';
    if (Array.isArray(list)) {
      list.forEach(item => {
        const id = typeof item === 'object' ? (item.ID || item.id || JSON.stringify(item)) : item;
        sel.innerHTML += `<option value="${escapeHtml(String(id))}">${escapeHtml(String(id))}</option>`;
      });
    }
  } catch {
    sel.innerHTML = '<option value="">Failed to load</option>';
  }
}

async function executePipeline() {
  const apiName = document.getElementById('api-select').value;
  if (!apiName) { alert('Please select an API'); return; }

  const bodyText = document.getElementById('pipeline-body').value;
  let body;
  try {
    body = JSON.parse(bodyText);
  } catch (e) {
    alert('Invalid JSON: ' + e.message);
    return;
  }

  const resultCard = document.getElementById('pipeline-result');
  const output = document.getElementById('pipeline-output');
  const statusEl = document.getElementById('pipeline-status');

  resultCard.style.display = 'block';
  output.innerHTML = '<span class="spinner"></span> Executing...';
  statusEl.className = 'status';
  statusEl.textContent = '';

  try {
    const result = await apiFetch('/api/' + encodeURIComponent(apiName), {
      method: 'POST',
      body: JSON.stringify(body)
    });
    output.innerHTML = formatJson(result);
    statusEl.textContent = 'Success';
    statusEl.className = 'status status-ok';
  } catch (e) {
    output.innerHTML = escapeHtml(e.message);
    statusEl.textContent = 'Error';
    statusEl.className = 'status status-err';
  }
}

// --- Metadata CRUD ---
async function loadMeta(table) {
  const container = document.getElementById('meta-list-' + table);
  if (!container) return;
  container.innerHTML = '<span class="spinner"></span> Loading...';
  document.getElementById('meta-detail-' + table).style.display = 'none';
  state.selectedMeta[table] = null;

  try {
    const list = await apiFetch('/meta/' + table);
    if (!Array.isArray(list) || list.length === 0) {
      container.innerHTML = '<div class="empty-state">No entries found</div>';
      return;
    }
    let html = '<table class="data-table"><thead><tr><th>ID</th><th>Summary</th></tr></thead><tbody>';
    list.forEach(item => {
      const id = typeof item === 'object' ? (item.ID || item.id || '') : item;
      let summary = '';
      if (typeof item === 'object') {
        const data = item.DATA || item.data;
        if (typeof data === 'string') {
          try { summary = Object.keys(JSON.parse(data)).join(', '); } catch { summary = data.substring(0, 60); }
        } else if (typeof data === 'object' && data !== null) {
          summary = Object.keys(data).join(', ');
        }
      }
      html += `<tr onclick="selectMetaEntry('${table}', '${escapeHtml(String(id))}')">
        <td><strong>${escapeHtml(String(id))}</strong></td>
        <td>${escapeHtml(summary)}</td>
      </tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (e) {
    container.innerHTML = `<div class="empty-state">Error loading: ${escapeHtml(e.message)}</div>`;
  }
}

async function selectMetaEntry(table, id) {
  const detailCard = document.getElementById('meta-detail-' + table);
  const detailContent = document.getElementById('meta-detail-content-' + table);
  detailCard.style.display = 'block';
  detailContent.innerHTML = '<span class="spinner"></span> Loading...';

  try {
    const data = await apiFetch('/meta/' + table + '/' + encodeURIComponent(id));
    state.selectedMeta[table] = { id, data };
    detailContent.innerHTML = formatJson(data);
  } catch (e) {
    detailContent.innerHTML = escapeHtml(e.message);
  }
}

function openMetaModal(table, editMode = false) {
  state.modalTable = table;
  state.modalMode = editMode ? 'edit' : 'create';

  const modal = document.getElementById('meta-modal');
  const titleEl = document.getElementById('modal-title');
  const idInput = document.getElementById('modal-id');
  const dataInput = document.getElementById('modal-data');

  if (editMode && state.selectedMeta[table]) {
    const entry = state.selectedMeta[table];
    titleEl.textContent = 'Edit Entry - ' + table;
    idInput.value = entry.id;
    idInput.readOnly = true;
    // Extract DATA field
    const raw = entry.data;
    let dataVal = raw;
    if (typeof raw === 'object' && raw !== null) {
      dataVal = raw.DATA || raw.data || raw;
      // If DATA is a string, try to parse it
      if (typeof dataVal === 'string') {
        try { dataVal = JSON.parse(dataVal); } catch {}
      }
    }
    dataInput.value = JSON.stringify(dataVal, null, 2);
  } else {
    titleEl.textContent = 'New Entry - ' + table;
    idInput.value = '';
    idInput.readOnly = false;
    dataInput.value = '{}';
  }

  modal.classList.add('open');
}

function closeModal() {
  document.getElementById('meta-modal').classList.remove('open');
}

async function saveMetaEntry() {
  const table = state.modalTable;
  const id = document.getElementById('modal-id').value.trim();
  const dataText = document.getElementById('modal-data').value;

  if (!id) { alert('ID is required'); return; }
  let dataObj;
  try {
    dataObj = JSON.parse(dataText);
  } catch (e) {
    alert('Invalid JSON in DATA: ' + e.message);
    return;
  }

  const payload = { ID: id, DATA: dataObj };
  const method = state.modalMode === 'edit' ? 'PUT' : 'POST';

  try {
    await apiFetch('/meta/' + table, {
      method,
      body: JSON.stringify(payload)
    });
    closeModal();
    loadMeta(table);
  } catch (e) {
    alert('Save failed: ' + e.message);
  }
}

function editMetaEntry(table) {
  if (!state.selectedMeta[table]) { alert('Select an entry first'); return; }
  openMetaModal(table, true);
}

async function deleteMetaEntry(table) {
  if (!state.selectedMeta[table]) { alert('Select an entry first'); return; }
  const id = state.selectedMeta[table].id;
  if (!confirm('Delete "' + id + '" from ' + table + '?')) return;

  try {
    await apiFetch('/meta/' + table + '/' + encodeURIComponent(id), { method: 'DELETE' });
    state.selectedMeta[table] = null;
    document.getElementById('meta-detail-' + table).style.display = 'none';
    loadMeta(table);
  } catch (e) {
    alert('Delete failed: ' + e.message);
  }
}

// --- Logs ---
async function loadLogs() {
  await Promise.all([loadLogTable('FG_LOG_API', 'api-logs'), loadLogTable('FG_LOG_FLOW', 'flow-logs')]);
}

async function loadLogTable(table, containerId) {
  const container = document.getElementById(containerId);
  container.innerHTML = '<span class="spinner"></span> Loading...';

  try {
    const list = await apiFetch('/meta/' + table);
    if (!Array.isArray(list) || list.length === 0) {
      container.innerHTML = '<div class="empty-state">No log entries</div>';
      return;
    }
    let html = '<table class="data-table"><thead><tr><th>ID</th><th>Info</th></tr></thead><tbody>';
    list.forEach(item => {
      const id = typeof item === 'object' ? (item.ID || item.id || '') : item;
      const escaped = escapeHtml(String(id));
      const info = typeof item === 'object'
        ? escapeHtml(JSON.stringify(item).substring(0, 80))
        : '';
      html += `<tr onclick="showLogDetail('${table}', '${escaped}')">
        <td>${escaped}</td>
        <td>${info}</td>
      </tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (e) {
    container.innerHTML = `<div class="empty-state">Error: ${escapeHtml(e.message)}</div>`;
  }
}

async function showLogDetail(table, id) {
  const card = document.getElementById('log-detail');
  const content = document.getElementById('log-detail-content');
  card.style.display = 'block';
  content.innerHTML = '<span class="spinner"></span> Loading...';

  try {
    const data = await apiFetch('/meta/' + table + '/' + encodeURIComponent(id));
    content.innerHTML = formatJson(data);
  } catch (e) {
    content.innerHTML = escapeHtml(e.message);
  }
}

// --- Transfer ---
let transferWs = null;
let transferId = null;
let transferSse = null;

async function loadTransferDatasources() {
  const sel = document.getElementById('transfer-datasource');
  try {
    const list = await apiFetch('/meta/FG_DATASOURCE');
    sel.innerHTML = '<option value="">-- Select Datasource --</option>';
    if (Array.isArray(list)) {
      list.forEach(item => {
        const id = typeof item === 'object' ? (item.ID || item.id || '') : item;
        sel.innerHTML += `<option value="${escapeHtml(String(id))}">${escapeHtml(String(id))}</option>`;
      });
    }
  } catch {
    sel.innerHTML = '<option value="">Failed to load</option>';
  }
}

async function loadActiveTransfers() {
  const card = document.getElementById('transfer-active-card');
  const container = document.getElementById('transfer-active-list');
  try {
    const list = await apiFetch('/transfer/active');
    if (!Array.isArray(list) || list.length === 0) {
      card.style.display = 'none';
      return;
    }
    card.style.display = 'block';
    let html = '<table class="data-table"><thead><tr><th>ID</th><th>File</th><th>Status</th><th>Progress</th></tr></thead><tbody>';
    list.forEach(t => {
      const pct = t.percentage || '0.0';
      const mb = ((t.bytesTransferred || 0) / 1048576).toFixed(1);
      html += `<tr>
        <td>${escapeHtml(String(t.transferId).substring(0, 8))}...</td>
        <td>${escapeHtml(t.filename || '')}</td>
        <td>${escapeHtml(t.status || '')}</td>
        <td>${mb} MB (${pct}%)</td>
      </tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch {
    card.style.display = 'none';
  }
}

function startTransfer() {
  const datasource = document.getElementById('transfer-datasource').value;
  const fileInput = document.getElementById('transfer-file');
  const filenameInput = document.getElementById('transfer-filename').value.trim();

  if (!datasource) { alert('Please select a datasource'); return; }
  if (!fileInput.files || fileInput.files.length === 0) { alert('Please select a file'); return; }

  const file = fileInput.files[0];
  const filename = filenameInput || file.name;
  const CHUNK_SIZE = 65536;

  const progressCard = document.getElementById('transfer-progress-card');
  progressCard.style.display = 'block';
  document.getElementById('transfer-start-btn').style.display = 'none';
  document.getElementById('transfer-cancel-btn').style.display = 'inline-flex';
  updateTransferUI(0, file.size, 0, 'Connecting...');

  const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
  transferWs = new WebSocket(`${protocol}//${location.host}/ws/transfer`);
  transferWs.binaryType = 'arraybuffer';

  transferWs.onopen = function() {
    transferWs.send(JSON.stringify({
      action: 'start',
      datasource: datasource,
      filename: filename,
      fileSize: file.size
    }));
  };

  transferWs.onmessage = function(event) {
    const msg = JSON.parse(event.data);
    if (msg.action === 'ready') {
      transferId = msg.transferId;
      updateTransferUI(0, file.size, 0, 'Transferring...');
      startSSE(transferId, file.size);
      sendChunks(file, CHUNK_SIZE);
    } else if (msg.action === 'error') {
      updateTransferUI(0, file.size, 0, 'Error: ' + msg.message);
      cleanupTransfer();
    }
  };

  transferWs.onerror = function() {
    updateTransferUI(0, file.size, 0, 'WebSocket error');
    cleanupTransfer();
  };

  transferWs.onclose = function() {
    // 정리는 SSE 또는 에러 핸들러에서 처리
  };
}

async function sendChunks(file, chunkSize) {
  const reader = file.stream().getReader();
  let buffer = new Uint8Array(0);

  try {
    while (true) {
      const { done, value } = await reader.read();

      if (value) {
        // buffer에 새 데이터 추가
        const newBuffer = new Uint8Array(buffer.length + value.length);
        newBuffer.set(buffer);
        newBuffer.set(value, buffer.length);
        buffer = newBuffer;
      }

      // 청크 크기 단위로 전송
      while (buffer.length >= chunkSize) {
        const chunk = buffer.slice(0, chunkSize);
        buffer = buffer.slice(chunkSize);

        // backpressure: bufferedAmount가 높으면 대기
        while (transferWs && transferWs.bufferedAmount > chunkSize * 4) {
          await new Promise(r => setTimeout(r, 50));
        }
        if (!transferWs || transferWs.readyState !== WebSocket.OPEN) return;
        transferWs.send(chunk.buffer);
      }

      if (done) break;
    }

    // 남은 데이터 전송
    if (buffer.length > 0) {
      while (transferWs && transferWs.bufferedAmount > chunkSize * 4) {
        await new Promise(r => setTimeout(r, 50));
      }
      if (transferWs && transferWs.readyState === WebSocket.OPEN) {
        transferWs.send(buffer.buffer);
      }
    }

    // 완료 신호
    if (transferWs && transferWs.readyState === WebSocket.OPEN) {
      transferWs.send(JSON.stringify({ action: 'complete' }));
    }
  } catch (e) {
    console.error('Error sending chunks:', e);
    updateTransferUI(0, file.size, 0, 'Send error: ' + e.message);
    cleanupTransfer();
  }
}

function startSSE(tid, totalBytes) {
  if (transferSse) { transferSse.close(); transferSse = null; }

  transferSse = new EventSource('/transfer/progress/' + encodeURIComponent(tid));

  transferSse.addEventListener('progress', function(event) {
    const data = JSON.parse(event.data);
    const bytes = data.bytesTransferred || 0;
    const total = data.totalBytes || totalBytes;
    const bps = data.bytesPerSecond || 0;
    const status = data.status || '';

    updateTransferUI(bytes, total, bps, status);

    if (status === 'COMPLETED' || status === 'FAILED' || status === 'CANCELLED') {
      cleanupTransfer();
      if (status === 'COMPLETED') {
        updateTransferUI(bytes, total, bps, 'Completed');
      } else if (status === 'FAILED') {
        updateTransferUI(bytes, total, bps, 'Failed: ' + (data.errorMessage || ''));
      }
    }
  });

  transferSse.addEventListener('error', function() {
    // SSE 연결 끊김 — 무시 (전송은 WS로 계속됨)
  });
}

function updateTransferUI(bytes, total, bps, statusText) {
  const mb = (bytes / 1048576).toFixed(1);
  const totalMb = (total / 1048576).toFixed(1);
  const rate = (bps / 1048576).toFixed(1);
  const pct = total > 0 ? ((bytes / total) * 100).toFixed(1) : '0.0';

  document.getElementById('transfer-info').textContent = mb + ' MB / ' + totalMb + ' MB';
  document.getElementById('transfer-rate').textContent = rate + ' MB/s';
  document.getElementById('transfer-bar').style.width = pct + '%';
  document.getElementById('transfer-percent').textContent = pct + '%';
  document.getElementById('transfer-status-text').textContent = statusText;
}

function cancelTransfer() {
  if (transferWs && transferWs.readyState === WebSocket.OPEN) {
    transferWs.close();
  }
  cleanupTransfer();
  updateTransferUI(0, 0, 0, 'Cancelled');
}

function cleanupTransfer() {
  if (transferSse) { transferSse.close(); transferSse = null; }
  if (transferWs) {
    try { transferWs.close(); } catch(e) {}
    transferWs = null;
  }
  transferId = null;
  document.getElementById('transfer-start-btn').style.display = 'inline-flex';
  document.getElementById('transfer-cancel-btn').style.display = 'none';
}

// --- Init ---
document.addEventListener('DOMContentLoaded', () => {
  checkHealth();
  loadApiList();
});
</script>

</body>
</html>
